<metal:block tal:define="viewletPath options/viewletPath;
                         usemacro python:viewletPath.find('/macros/') != -1">

<metal:globaldefine tal:define="
        global utool nocall:here/portal_url;
        global portal utool/getPortalObject;
        global portal_object nocall:portal;
        global portal_url utool;
        global here_url here/absolute_url;
        global site_properties portal/portal_properties/site_properties;
        global mtool nocall:portal/portal_membership;
        global gtool nocall:portal/portal_groups | nothing;
        global gdtool nocall:portal/portal_groupdata | nothing;
        global atool nocall:portal/portal_actions;
        global putils nocall:portal/plone_utils;
        global wtool nocall:portal/portal_workflow;
        global ifacetool nocall:portal/plone_interface | nothing;
        global member mtool/getAuthenticatedMember;
        global isAnon mtool/isAnonymousUser;
        global checkPermission nocall:mtool/checkPermission;
        global Iterator python:modules['Products.CMFPlone'].IndexIterator;
        global tabindex python:Iterator(pos=80000);
        global contentpanels nocall:options/contentpanels; 
        "/>

    <div class="portlet-wrap" 
         tal:attributes="class string:viewlet ${options/panelSkin};
                         id here/getId" >
        <metal:block tal:condition="usemacro">
           <metal:block metal:use-macro="python:path(viewletPath)" />
        </metal:block>
        <metal:block tal:replace="structure python:path(viewletPath)" 
                   tal:condition="not: usemacro"/>
    </div>

</metal:block>

